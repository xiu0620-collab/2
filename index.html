<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZPD å°å¤©ä½¿ç‰¹å‹™ä¸­å¿ƒ</title>
    <script type="module">
        // Firebase å°‡åœ¨ä¸‹æ–¹è¼‰å…¥
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            --judy-blue: #1565C0;
            --judy-dark: #0D47A1;
            --nick-green: #66BB6A;
            --carrot-orange: #FF7043;
            --badge-gold: #FFD54F;
            --bg-color: #E3F2FD;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            /* èƒŒæ™¯è£é£¾ï¼šæ¨¡æ“¬å‹•ç‰©æ–¹åŸå¸‚çš„å¤©éš›ç·šæˆ–æ°›åœ */
            background-image: 
                linear-gradient(135deg, rgba(255,255,255,0.5) 25%, transparent 25%),
                linear-gradient(225deg, rgba(255,255,255,0.5) 25%, transparent 25%),
                linear-gradient(45deg, rgba(255,255,255,0.5) 25%, transparent 25%),
                linear-gradient(315deg, rgba(255,255,255,0.5) 25%, transparent 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 40px 40px;
            background-repeat: repeat;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* æ¨™é¡Œå€ï¼šZPD é¢¨æ ¼ */
        .header-box {
            background: #fff;
            border: 5px solid var(--judy-dark);
            border-radius: 20px;
            padding: 15px 40px;
            box-shadow: 0 8px 0 rgba(13, 71, 161, 0.2);
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .header-box::before {
            content: 'ğŸš“';
            position: absolute; left: -20px; top: 50%; transform: translateY(-50%);
            font-size: 3rem;
        }
        .header-box::after {
            content: 'ğŸ¦Š';
            position: absolute; right: -20px; top: 50%; transform: translateY(-50%);
            font-size: 3rem;
        }

        h1 { 
            margin: 0; 
            color: var(--judy-dark); 
            letter-spacing: 2px; 
            font-weight: 900;
            text-transform: uppercase;
        }
        
        .status-bar { 
            font-size: 0.9rem; 
            color: var(--carrot-orange); 
            margin-top: 5px; 
            font-weight: bold; 
            background: #FFF3E0;
            padding: 2px 10px;
            border-radius: 10px;
            display: inline-block;
        }

        .container {
            width: 100%; max-width: 900px;
            /* ç»ç’ƒæ“¬æ…‹ */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid white;
        }

        .instruction {
            color: #555;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
            font-weight: 600;
        }

        .name-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* æŒ‰éˆ•ï¼šè­¦å¾½é€ å‹ */
        .name-btn {
            background: linear-gradient(135deg, var(--badge-gold), #FFC107);
            color: #5d4037;
            border: 3px solid #FFF8E1;
            padding: 10px 5px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆè·³æ•ˆæœ */
            box-shadow: 0 5px 15px rgba(255, 213, 79, 0.4);
            height: 120px; 
            width: 100%;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            /* ç›¾ç‰Œå½¢ç‹€ */
            clip-path: polygon(50% 0%, 100% 15%, 100% 85%, 50% 100%, 0% 85%, 0% 15%);
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .name-btn::before {
            content: 'â­';
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }

        .name-btn:hover:not(.drawn) {
            transform: translateY(-8px) scale(1.05);
            background: linear-gradient(135deg, var(--carrot-orange), #FF5722);
            color: white;
            z-index: 5;
            text-shadow: none;
        }

        /* å·²æŠ½éæ¨£å¼ */
        .name-btn.drawn {
            background: #546E7A !important;
            color: #CFD8DC !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* ä»»å‹™å®Œæˆå°ç«  */
        .stamp {
            position: absolute; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            width: 90%;
            border: 3px dashed #FFF; 
            color: #FFF;
            font-size: 14px; 
            padding: 5px;
            background: rgba(0,0,0,0.3);
            font-weight: 900;
            z-index: 2;
        }

        /* é‡ç½®æŒ‰éˆ• */
        .reset-area { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        .reset-btn { 
            background: #37474F; color: #fff; border: none; 
            padding: 10px 20px; cursor: pointer; border-radius: 50px; 
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: 0.3s;
        }
        .reset-btn:hover { background: #263238; transform: scale(1.05); }
        
        /* è¼‰å…¥é®ç½© */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--judy-blue); z-index: 20000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            color: white;
        }

        /* --- Modal: æ©Ÿå¯†æª”æ¡ˆé¢¨æ ¼ --- */
        #temple-modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,20,40,0.9);
            z-index: 9999; justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(8px);
        }

        /* æ©Ÿå¯†æ–‡ä»¶è¢‹ */
        .secret-folder {
            width: 240px; height: 180px;
            background: #D7CCC8; /* ç´™è¢‹è‰² */
            position: relative;
            border-radius: 5px;
            border-bottom: 10px solid #A1887F;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .secret-folder::before {
            content: 'TOP SECRET';
            color: #A93226;
            font-weight: 900;
            font-size: 24px;
            border: 4px solid #A93226;
            padding: 5px 15px;
            transform: rotate(-10deg);
            opacity: 0.8;
            mask-image: url("data:image/svg+xml;utf8,<svg ...>"); /* å¯ä»¥åœ¨é€™è£¡åŠ æ–‘é§æ•ˆæœï¼Œé€™è£¡ç•¥é */
        }
        
        .secret-folder::after {
            content: 'ZPD CASE #007';
            position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: #5d4037; font-family: monospace;
        }

        /* æ–‡ä»¶å¡ç‰‡ */
        .mission-card {
            position: absolute;
            width: 200px; height: 260px;
            background: #fff;
            top: 10px; /* åˆå§‹åœ¨è¢‹å­è£¡ */
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 15px;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: -1; /* åœ¨è¢‹å­å¾Œé¢ */
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .mission-card.revealed {
            transform: translateY(-200px) scale(1.1); /* å¾€ä¸Šå½ˆå‡º */
            z-index: 100; /* è·‘åˆ°è¢‹å­å‰é¢ */
        }

        .mission-avatar {
            font-size: 50px; margin-bottom: 10px;
            filter: drop-shadow(0 5px 0 rgba(0,0,0,0.1));
        }

        .target-label { font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .target-name { font-size: 36px; color: var(--judy-dark); font-weight: 900; margin: 5px 0; }
        .mission-note { font-size: 12px; color: var(--carrot-orange); font-weight: bold; }

        .close-btn {
            background: var(--judy-blue); color: #fff; border: none;
            padding: 12px 30px; font-size: 16px; cursor: pointer;
            border-radius: 50px; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.4);
            transition: 0.2s;
            font-weight: bold;
        }
        .close-btn:hover { transform: scale(1.05); background: var(--judy-dark); }

        /* å‹•ç•« Class */
        .shake-folder { animation: shakeFolder 0.5s infinite; }
        
        @keyframes shakeFolder {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(3deg); }
            50% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
            100% { transform: rotate(0deg); }
        }

        /* å½©å¸¶ç‰¹æ•ˆ Canvas */
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10001;
        }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 4rem;">ğŸ©</div>
        <h2>æ­£åœ¨é€£ç·šè‡³ ZPD è³‡æ–™åº«...</h2>
        <p>è«‹ç¨å€™ï¼Œæ¨¹æ‡¶æ­£åœ¨è™•ç†ä¸­...</p>
    </div>

    <div class="header-box">
        <h1>ZPD ç§˜å¯†ä»»å‹™ä¸­å¿ƒ</h1>
        <div class="status-bar" id="reset-status">é€£ç·šä¸­...</div>
    </div>
    
    <div class="container">
        <p class="instruction">
            å„ä½ç‰¹å‹™ï¼Œè«‹é»æ“Šå±¬æ–¼ä½ çš„<strong style="color:var(--judy-blue)">ã€Œè­¦å¾½ã€</strong>é ˜å–ä»»å‹™ã€‚<br>
            <span style="font-size:0.9em; color:#888;">ï¼ˆä½ çš„å®ˆè­·å°è±¡æ˜¯æœ€é«˜æ©Ÿå¯†ï¼Œè«‹å‹¿æ´©æ¼ï¼‰</span>
        </p>
        <div class="name-grid" id="nameGrid"></div>
    </div>

    <div class="reset-area">
        <button class="reset-btn" id="resetBtn">â†º å±€é•·é‡ç½®ç³»çµ±</button>
    </div>

    <div id="temple-modal">
        <canvas id="confetti-canvas"></canvas>

        <div style="position: relative; margin-top: 100px;">
            <div id="mission-card" class="mission-card">
                <div>
                    <div class="mission-avatar">ğŸ°</div>
                    <div class="target-label">Mission Target</div>
                    <div class="target-name" id="target-name">???</div>
                </div>
                <div class="mission-note">é€™æ˜¯ä¸€ä»½æ©Ÿå¯†ä»»å‹™ã€‚<br>è«‹é»˜é»˜å®ˆè­·ç›®æ¨™ã€‚</div>
                <button class="close-btn" id="confirm-close-btn">æ”¶åˆ°ä»»å‹™ (é—œé–‰)</button>
            </div>

            <div id="secret-folder" class="secret-folder"></div>
        </div>
        
        <div id="process-text" style="color:white; margin-top:40px; font-size:1.5rem; font-weight:bold; letter-spacing:2px;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ========================================================
        // 2. è¨­å®šå€ (è«‹ç”¨ä½ çš„è¨­å®šè¦†è“‹é€™è£¡!)
        // ========================================================
        const firebaseConfig = {
  apiKey: "AIzaSyC1o8tki1FfKcImKd81K_20nGepvhtg10U",
  authDomain: "angel-2a4d7.firebaseapp.com",
  databaseURL: "https://angel-2a4d7-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "angel-2a4d7",
  storageBucket: "angel-2a4d7.firebasestorage.app",
  messagingSenderId: "213601480494",
  appId: "1:213601480494:web:f418fada90ea2ffcfc94bf",
  measurementId: "G-ES649SK0T6"
        };
        // ========================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASSWORD = "888";

        const names = [
            "é™³æ€ç©", "åŠ‰é›…è", "åŠ‰ä»²ä¿®", "è©¹ç´”è“‰", 
            "é™³æ€¡æ½”", "æç¬äº‘", "é™³çŸä¼¶", "ç‹æƒ æ…ˆ", 
            "ä½•èŠ·éœ“", "ç‹è–ç¿", "å¾å¿—æ˜"
        ];
        
        // å°æ‡‰çš„å‹•ç‰©é ­åƒ (éš¨æ©Ÿåˆ†é…æˆ–æ˜¯æŒ‡å®šçš†å¯ï¼Œé€™è£¡éš¨æ©Ÿé¸ä¸€äº›å¯æ„›çš„)
        const animals = ["ğŸ¦Š", "ğŸ°", "ğŸ¦", "ğŸ¯", "ğŸ¨", "ğŸ¼", "ğŸ»", "ğŸ­", "ğŸ¹", "ğŸ·", "ğŸ¸"];

        let currentAssignments = {};
        let currentDrawn = {};
        let resetCount = 0;

        // Firebase ç›£è½
        const gameRef = ref(db, 'angel_game');
        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                performReset(true); 
            } else {
                currentAssignments = data.assignments || {};
                currentDrawn = data.drawn || {};
                resetCount = data.resetCount || 0;
                renderButtons();
                updateStatusText();
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        function renderButtons() {
            const grid = document.getElementById('nameGrid');
            grid.innerHTML = ''; 
            
            names.forEach(name => {
                let btn = document.createElement('div');
                btn.className = 'name-btn';
                btn.innerHTML = `<span>${name}</span>`; // ç”¨ span åŒ…èµ·ä¾†æ–¹ä¾¿æ’ç‰ˆ
                
                if (currentDrawn[name] === true) {
                    markButtonAsDrawn(btn);
                } else {
                    btn.onclick = () => startDraw(name, btn);
                }
                grid.appendChild(btn);
            });
        }

        function markButtonAsDrawn(btn) {
            if (btn.querySelector('.stamp')) return;
            btn.classList.add('drawn');
            btn.onclick = null;
            // è®Šæˆå·²åˆ†æ´¾åœ–ç¤º
            btn.innerHTML = `<div style="font-size:2rem;">ğŸ“</div><div style="font-size:0.8rem;">CASE CLOSED</div>`;
            // è“‹ç« 
            let stamp = document.createElement('div');
            stamp.className = 'stamp';
            stamp.innerText = 'MISSION ASSIGNED';
            btn.appendChild(stamp);
        }

        // --- æŠ½ç±¤èˆ‡å‹•ç•« ---
        window.startDraw = function(name, btnElement) {
            if(!confirm(`ç¢ºèªèº«ä»½ï¼šç‰¹å‹™ã€${name}ã€‘\n\nè¦é ˜å–æ‚¨çš„ç§˜å¯†ä»»å‹™å—ï¼Ÿ`)) return;

            const modal = document.getElementById('temple-modal');
            const folder = document.getElementById('secret-folder');
            const card = document.getElementById('mission-card');
            const processText = document.getElementById('process-text');
            const targetNameDisplay = document.getElementById('target-name');

            modal.style.display = 'flex';
            processText.style.display = 'block';
            processText.innerText = "è§£é–æ©Ÿå¯†æª”æ¡ˆä¸­...";
            
            // é‡ç½®å‹•ç•«ç‹€æ…‹
            folder.classList.add('shake-folder');
            card.classList.remove('revealed');
            
            // 1. éœ‡å‹•è³‡æ–™å¤¾ (1.5ç§’)
            setTimeout(() => {
                folder.classList.remove('shake-folder');
                processText.innerText = "æª”æ¡ˆè§£é–æˆåŠŸï¼";
                
                // 2. å¡ç‰‡å½ˆå‡º
                setTimeout(() => {
                    card.classList.add('revealed');
                    
                    // é¡¯ç¤ºå°è±¡
                    const target = currentAssignments[name];
                    targetNameDisplay.innerText = target || "é€£ç·šéŒ¯èª¤";
                    processText.style.display = 'none';
                    
                    // 3. æ”¾å½©å¸¶ç‰¹æ•ˆ
                    fireConfetti();

                    // æ›´æ–°è³‡æ–™åº«
                    update(ref(db, 'angel_game/drawn'), { [name]: true });

                }, 500);
            }, 1500);
        }

        // --- å½©å¸¶ç‰¹æ•ˆé‚è¼¯ (ç´” JS æ¨¡æ“¬) ---
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const colors = ['#f44336', '#2196F3', '#FFEB3B', '#4CAF50', '#FF9800'];
            
            for(let i=0; i<100; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 1) * 20,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    life: 100
                });
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) {
                        active = true;
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // é‡åŠ›
                        p.life--;
                        
                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                if(active) requestAnimationFrame(draw);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            draw();
        }

        document.getElementById('confirm-close-btn').addEventListener('click', () => {
            document.getElementById('temple-modal').style.display = 'none';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            const pwd = prompt("è«‹è¼¸å…¥è »ç‰›å±€é•·çš„å¯†ç¢¼ï¼š");
            if (pwd === ADMIN_PASSWORD) {
                if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰ç‰¹å‹™çš„ä»»å‹™é€²åº¦ï¼ç¢ºå®šåŸ·è¡Œï¼Ÿ")) {
                    performReset();
                }
            } else if (pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼è«‹ä¸è¦éš¨æ„å˜—è©¦ã€‚");
            }
        });

        function performReset(isInit = false) {
            let shuffled = [...names];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            let newAssignments = {};
            for (let i = 0; i < shuffled.length; i++) {
                newAssignments[shuffled[i]] = shuffled[(i + 1) % shuffled.length];
            }

            const newGameData = {
                assignments: newAssignments,
                drawn: {},
                resetCount: isInit ? 0 : (resetCount + 1),
                lastUpdated: Date.now()
            };

            set(ref(db, 'angel_game'), newGameData);
        }

        function updateStatusText() {
            const statusEl = document.getElementById('reset-status');
            statusEl.innerText = resetCount === 0 
                ? "ç³»çµ±ç‹€æ…‹ï¼šåˆå§‹æº–å‚™å°±ç·’" 
                : `ç³»çµ±ç‹€æ…‹ï¼šç¬¬ ${resetCount} è¼ªä»»å‹™åˆ†æ´¾ä¸­`;
        }
    </script>
</body>
</html>
